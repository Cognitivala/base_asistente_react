
<html lang="es-CL" dir="ltr" xmlns:og="http://opengraphprotocol.org/schema/" xmlns:fb="http://ogp.me/ns/fb#" heightfull="heightfull">
  <head>
    <title>Administrador Usuarios. MAD Cognitiva</title>
    <meta charset="UTF-8"/>
    <link rel="profile" href="http://gmpg.org/xfn/11"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    <link rel="apple-touch-icon" sizes="57x57" href="http://asistente-react.mycognitiva.io/assets/img/favicon/apple-icon-57x57.png"/>
    <link rel="apple-touch-icon" sizes="60x60" href="http://asistente-react.mycognitiva.io/assets/img/favicon/apple-icon-60x60.png"/>
    <link rel="apple-touch-icon" sizes="72x72" href="http://asistente-react.mycognitiva.io/assets/img/favicon/apple-icon-72x72.png"/>
    <link rel="apple-touch-icon" sizes="76x76" href="http://asistente-react.mycognitiva.io/assets/img/favicon/apple-icon-76x76.png"/>
    <link rel="apple-touch-icon" sizes="114x114" href="http://asistente-react.mycognitiva.io/assets/img/favicon/apple-icon-114x114.png"/>
    <link rel="apple-touch-icon" sizes="120x120" href="http://asistente-react.mycognitiva.io/assets/img/favicon/apple-icon-120x120.png"/>
    <link rel="apple-touch-icon" sizes="144x144" href="http://asistente-react.mycognitiva.io/assets/img/favicon/apple-icon-144x144.png"/>
    <link rel="apple-touch-icon" sizes="152x152" href="http://asistente-react.mycognitiva.io/assets/img/favicon/apple-icon-152x152.png"/>
    <link rel="apple-touch-icon" sizes="180x180" href="http://asistente-react.mycognitiva.io/assets/img/favicon/apple-icon-180x180.png"/>
    <link rel="icon" type="image/png" sizes="192x192" href="http://asistente-react.mycognitiva.io/assets/img/favicon/android-icon-192x192.png"/>
    <link rel="icon" type="image/png" sizes="32x32" href="http://asistente-react.mycognitiva.io/assets/img/favicon/favicon-32x32.png"/>
    <link rel="icon" type="image/png" sizes="96x96" href="http://asistente-react.mycognitiva.io/assets/img/favicon/favicon-96x96.png"/>
    <link rel="icon" type="image/png" sizes="16x16" href="http://asistente-react.mycognitiva.io/assets/img/favicon/favicon-16x16.png"/>
    <link rel="manifest" href="http://asistente-react.mycognitiva.io/assets/img/favicon/manifest.json"/>
    <meta name="msapplication-TileColor" content="#000000"/>
    <meta name="msapplication-TileImage" content="http://asistente-react.mycognitiva.io/assets/img/favicon/ms-icon-144x144.png"/>
    <meta name="theme-color" content="#000000"/>
    <meta name="_csrf" content=""/>
    <meta name="insight-app-sec-validation" content="4d0a31e7-ca78-40a0-b0dd-a0b8415541e4"/>
    <meta name="apptrana" content="37adefb730ca40ca9d12cb9e55ed2ca3"/>
    <link href="http://asistente-react.mycognitiva.io/assets/css/main.css" rel="stylesheet"/>
    <link href="http://asistente-react.mycognitiva.io/assets/img/favicon/favicon-32x32.png" rel="Shortcut Icon"/><!--[if lt IE 9]><script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script><script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script><![endif]-->
  </head>
  <body class="no-scroll" heightfull="heightfull">
    <div id="wrapper" heightfull="heightfull">
      <div class="f-row" heightfull="heightfull">
        <div class="f-col menu" heightfull="heightfull" padding="padding">
          <div class="header">
            <div class="f-row align-center">
              <div class="f-col cognitiva-logo"><img src="http://asistente-react.mycognitiva.io/assets/img/cognitiva-logo.png" alt=""/></div>
            </div>
          </div>
          <ul class="menu" id="mainmenu">
            <li><a href="http://asistente-react.mycognitiva.io/"><i class="fa fa-cog" aria-hidden="true"></i>Configurar Asistente</a></li>
            <li><a href="http://asistente-react.mycognitiva.io/personalizar/"><i class="fa fa-paint-brush" aria-hidden="true"></i>Personalizar Asistente</a></li>
            <li><a href="http://asistente-react.mycognitiva.io/indicadores/"><i class="fa fa-bar-chart" aria-hidden="true"></i>Indicadores</a>
              <ul class="sub-menu">
                <li><a href="http://asistente-react.mycognitiva.io/indicadores/interacciones/"><i class="fa fa-caret-right" aria-hidden="true"></i>Interacciones</a></li>
                <li><a href="http://asistente-react.mycognitiva.io/indicadores/valoraciones/"><i class="fa fa-caret-right" aria-hidden="true"></i>Valoraciones</a></li>
                <li><a href="http://asistente-react.mycognitiva.io/indicadores/tmo/"><i class="fa fa-caret-right" aria-hidden="true"></i>TMO</a></li>
                <li><a href="http://asistente-react.mycognitiva.io/indicadores/origen/"><i class="fa fa-caret-right" aria-hidden="true"></i>Origen</a></li>
                <li><a href="http://asistente-react.mycognitiva.io/indicadores/nps/"><i class="fa fa-caret-right" aria-hidden="true"></i>NPS</a></li>
              </ul>
            </li>
            <li id="admin-users-btn"><a href="http://asistente-react.mycognitiva.io/administrador-usuarios/"><i class="fa fa-users" aria-hidden="true"></i>Administrador Usuarios</a></li>
            <li><a class="get-code" href="#;" onclick="openScript()"><i class="fa fa-code" aria-hidden="true"></i>Obtener código</a></li>
          </ul>
        </div>
        <div class="f-col content" padding="padding" heightfull="heightfull">
          <div class="row">
            <div class="col-md-12 content-header">
              <div class="mad-cognitiva">
                <h5>Mantenedor Asistente Digital / <span></span></h5>
              </div>
              <button class="user" button="button" onclick="closeSession()">
                <div id="user">Hola, <span>Ernesto</span></div><i class="fa fa-hand-peace-o"></i>
              </button>
            </div>
          </div>
          <div class="row">
            <div class="col-md-12">
              <div class="container-tabs" id="users-list">
                <div class="block">
                  <button button="button" button-mini="button-mini" margin-bottom="margin-bottom" onclick="openModal('Añadir nuevo usuario', '#myModalUser')">Añadir Usuario <i class="fa fa-user-plus" aria-hidden="true"></i></button>
                  <div class="scroll" id="AddTable">
                    <table class="table table-striped table-bordered">
                      <thead>
                        <tr>
                          <th>Nombre</th>
                          <th>Correo</th>
                          <th>Perfil</th>
                          <th width="100">Acciones</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr id="no-users">
                          <td colspan="4" text-center="text-center">No hay usuarios</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button class="close" type="button" data-dismiss="modal" aria-label="Close"><i class="fa fa-close"></i></button>
            <h6 class="modal-title"></h6>
          </div>
          <div class="modal-body"></div>
        </div>
      </div>
    </div>
    <div class="modal fade" id="myModalScript" tabindex="-1" role="dialog" aria-labelledby="myModalScriptLabel">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button class="close" type="button" data-dismiss="modal" aria-label="Close"><i class="fa fa-close"></i></button>
            <h6 class="modal-title">Copia y pega el siguiente código en tu web. Después de <span class="code"><span>&lt;</span>head<span>&gt;</span></span> y antes de <span class="code"><span>&lt;/</span>head<span>&gt;</span></span></h6>
          </div>
          <div class="modal-body">
            <pre text-left="text-left"></pre>
          </div>
        </div>
      </div>
    </div>
    <div class="modal fade" id="myModalUser" tabindex="-1" role="dialog" aria-labelledby="myModalUserLabel">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="form">
            <div class="modal-header">
              <h6 class="modal-title"></h6>
            </div>
            <div class="modal-body" text-left="text-left">
              <fieldset>
                <label>Perfil</label>
                <select id="user-profile" name="user-profile">
                  <option value="" selected="selected" disabled="disabled">Seleccione</option>
                  <option value="1">Editor</option>
                  <option value="2">Lector</option>
                </select>
              </fieldset>
              <fieldset>
                <label>Nombre</label>
                <input id="user-name" type="text" name="user-name" placeholder="Nombre usuario"/>
              </fieldset>
              <fieldset>
                <label>Email</label>
                <input id="user-mail" type="email" name="user-mail" maxlength="128"/>
              </fieldset>
            </div>
            <div class="modal-footer">
              <button class="pull-left" id="validate" type="submit" button="button" onclick="saveUser()">Guardar</button>
              <button class="pull-right" type="button" data-dismiss="modal" button="button" close="close" onclick="removeData()">Cancelar</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="modal fade" id="myModalDeleteUser" tabindex="-1" role="dialog" aria-labelledby="myModalDeleteUserLabel">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h6 class="modal-title"></h6>
          </div>
          <div class="modal-body" id="user-id-delete"></div>
          <div class="modal-footer">
            <button class="pull-left" type="button" data-dismiss="modal" button="button" delete="delete" onclick="confirmDeleteUser()">Eliminar </button>
            <button type="button" data-dismiss="modal" button="button" close="close" onclick="removeData()">Cerrar</button>
          </div>
        </div>
      </div>
    </div>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script type="text/javascript" src="http://asistente-react.mycognitiva.io/assets/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="http://asistente-react.mycognitiva.io/assets/js/main.js"></script>
    <script>
      var getPrf = sessionStorage.getItem('prf'),
          getSession = "1",
          getTkn = sessionStorage.getItem('tkn');
      
      if(getPrf < 2) {
        function showTooltip(){
          $('[data-toggle="tooltip"]').tooltip({trigger: "hover"});
        }
        showTooltip();
        
        function listUsers() {
      
          var promise = $.ajax({
            type: 'POST',
            url: getPath + 'mant/listusers',
            "headers": {
              "Content-Type": "application/json",
              "Authorization": "Bearer "+getTkn
            },
            //- data: JSON.stringify(args),
            dataType: 'json',
            contentType: 'application/json; charset=utf-8'
          }).done(function(response){
            if(response.status == 200){
              //- console.log(response);
              var craeteTrUser = '';
              for(var i = 0; i < response.descripcion.length; i ++){
                var addProfile = '';
                if (response.descripcion[i].perfil == null){
                  addProfile = 'Añade Perfil';
                } else if(response.descripcion[i].perfil == 0){
                  addProfile = 'Super Admin';
                } else if(response.descripcion[i].perfil == 1){
                  addProfile = 'Editor';
                } else {
                  addProfile = 'Lector';
                }
                var editUser = "editUser(this, '#myModalUser'); openModal('Editar usuario', '#myModalUser')";
                var deleUser = "deleteUser(this); openModal('¿Está seguros de eliminar a este usuario?', '#myModalDeleteUser')";
                var craeteTrUser = '<tr>';
                    craeteTrUser += '  <td>'+response.descripcion[i].nombre+'</td>';
                    craeteTrUser += '  <td>'+response.descripcion[i].email+'</td>';
                    craeteTrUser += '  <td>'+addProfile+'</td>';
                    craeteTrUser += '  <td>';
                    craeteTrUser += '    <ul class="user-actions">';
                    craeteTrUser += '      <li><a href="#;" data-toggle="tooltip" data-placement="top" title="Editar Usuario" onclick="'+editUser+'"><i class="fa fa-pencil" aria-hidden="true"></i></a></li>';
                    craeteTrUser += '      <li><a href="#;" data-toggle="tooltip" data-placement="top" title="Eliminar Usuario" onclick="'+deleUser+'"><i class="fa fa-trash" aria-hidden="true"></i></a></li>';
                    craeteTrUser += '    </ul>';
                    craeteTrUser += '  </td>';
                    craeteTrUser += '</tr>';
                if( getPrf > 0 && response.descripcion[i].perfil > 0 ){
                  $('#AddTable tbody').append(craeteTrUser);
                }
                if(getPrf == 0){
                  $('#AddTable tbody').append(craeteTrUser);
                }
              }
              $('#AddTable #no-users').remove();
              showTooltip();
            } else {
              //- console.log("Error loading page\n");
            }
          });
      
          //- var req = new XMLHttpRequest();
          //- req.open('POST', getPath+'mant/listusers', true); 
          //- req.send(null);
          //- req.onreadystatechange = function (aEvt) {
          //-   if (req.readyState == 4) {
          //-     if (req.status == 200) {
          //-       var response = JSON.parse(req.responseText);
          //-       console.log(response);
          //-       var craeteTrUser = '';
          //-       for(var i = 0; i < response.descripcion.length; i ++){
          //-         var addProfile = '';
          //-         if (response.descripcion[i].perfil == null){
          //-           addProfile = 'Añade Perfil';
          //-         } else if(response.descripcion[i].perfil == 0){
          //-           addProfile = 'Super Admin';
          //-         } else if(response.descripcion[i].perfil == 1){
          //-           addProfile = 'Editor';
          //-         } else {
          //-           addProfile = 'Lector';
          //-         }
      
          //-         var editUser = "editUser(this, '#myModalUser'); openModal('Editar usuario', '#myModalUser')";
          //-         var deleUser = "deleteUser(this); openModal('¿Está seguros de eliminar a este usuario?', '#myModalDeleteUser')";
          //-         var craeteTrUser = '<tr>';
          //-             craeteTrUser += '  <td>'+response.descripcion[i].nombre+'</td>';
          //-             craeteTrUser += '  <td>'+response.descripcion[i].email+'</td>';
          //-             craeteTrUser += '  <td>'+addProfile+'</td>';
          //-             craeteTrUser += '  <td>';
          //-             craeteTrUser += '    <ul class="user-actions">';
          //-             craeteTrUser += '      <li><a href="#;" data-toggle="tooltip" data-placement="top" title="Editar Usuario" onclick="'+editUser+'"><i class="fa fa-pencil" aria-hidden="true"></i></a></li>';
          //-             craeteTrUser += '      <li><a href="#;" data-toggle="tooltip" data-placement="top" title="Eliminar Usuario" onclick="'+deleUser+'"><i class="fa fa-trash" aria-hidden="true"></i></a></li>';
          //-             craeteTrUser += '    </ul>';
          //-             craeteTrUser += '  </td>';
          //-             craeteTrUser += '</tr>';
      
          //-         if( getPrf > 0 && response.descripcion[i].perfil > 0 ){
          //-           $('#AddTable tbody').append(craeteTrUser);
          //-         }
          //-         if(getPrf == 0){
          //-           $('#AddTable tbody').append(craeteTrUser);
          //-         }
      
          //-       }
          //-       $('#AddTable #no-users').remove();
          //-       showTooltip();
          //-     } else {
          //-       console.log("Error loading page\n");
          //-     }
          //-   }
      
          //- };
      
        }
        listUsers();
      
        function validateEmail(email) {
          var regex = /^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/;
          return regex.test(email) ? true : false;
        }
        
        function openModal(title, modal) {
          $(modal + ' .modal-title').empty().text(title);
          $(modal).modal('show');
        }
        
        function editUser(el, modal) {
          var getTtr        = el.parentElement.parentElement.parentElement.parentElement,
              getNameTd     = getTtr.children[0].textContent,
              getEmailTd    = getTtr.children[1].textContent,
              getProfileTd  = getTtr.children[2].textContent,
              setValProfile = 0;
          getTtr.className = 'action';
          if(getProfileTd == 'Editor') {
            setValProfile = 1
          } else {
            setValProfile = 2
          }
          $(modal + ' #user-name').val(getNameTd);
          $(modal + ' #user-mail').val(getEmailTd);
          $(modal + ' #user-profile').val(setValProfile);
        }
        
        var mailBool      = false;
      
        function saveUser() {
          var getNameVal    = document.getElementById('user-name').value,
              getEmailVal   = document.getElementById('user-mail').value,
              getProfileVal = document.getElementById('user-profile').value,
              addValProfile = '',
              getSelect     = false;
          if(getProfileVal.length > 0){
            getSelect = true;
          } else {
            getSelect = false;
          }
          if(!validateEmail(getEmailVal)){
            var emailfield  = document.getElementById('user-mail');
            emailfield.setCustomValidity("Complete el campo correspondiente");
          }
          if(getEmailVal != '' && getNameVal != '' && getSelect == true && validateEmail(getEmailVal) == true){
            if(getProfileVal == 1){
              addValProfile = 'Editor';
            } else {
              addValProfile = 'Lector';
            }
            var editUser = "editUser(this, '#myModalUser'); openModal('Editar usuario', '#myModalUser')";
            var deleUser = "deleteUser(this); openModal('¿Está seguros de eliminar a este usuario?', '#myModalDeleteUser')";
            var craeteTrUser = '<tr>';
                craeteTrUser += '  <td>'+getNameVal+'</td>';
                craeteTrUser += '  <td>'+getEmailVal+'</td>';
                craeteTrUser += '  <td>'+addValProfile+'</td>';
                craeteTrUser += '  <td>';
                craeteTrUser += '    <ul class="user-actions">';
                craeteTrUser += '      <li><a href="#;" data-toggle="tooltip" data-placement="top" title="Editar Usuario" onclick="'+editUser+'"><i class="fa fa-pencil" aria-hidden="true"></i></a></li>';
                craeteTrUser += '      <li><a href="#;" data-toggle="tooltip" data-placement="top" title="Eliminar Usuario" onclick="'+deleUser+'"><i class="fa fa-trash" aria-hidden="true"></i></a></li>';
                craeteTrUser += '    </ul>';
                craeteTrUser += '  </td>';
                craeteTrUser += '</tr>';
            if($('.table tbody tr').hasClass('action')){
      
              var args = {
                nombre: getNameVal,
                email: getEmailVal,
                perfil: getProfileVal
              }
              var promise = $.ajax({
                type: 'POST',
                url: getPath + 'mant/edituser',
                headers: {
                  "Content-Type": "application/json",
                  "Authorization": "Bearer "+getTkn
                },
                data: JSON.stringify(args),
                dataType: 'json',
                contentType: 'application/json; charset=utf-8'
              }).done(function(response){
                if(estado.codigoEstado  != '200'){
                  //- console.log(response);
                  openCustomModal('#myModal', 'Genial!', 'El usuario se ha editado con éxito', 'success');
                }else{
                  openCustomModal('#myModal', 'Genial!', 'No se ha podido ediar el usuario', 'error');
                }
              })
      
              $('tr.action td:nth-child(1)').text(getNameVal);
              $('tr.action td:nth-child(2)').text(getEmailVal);
              $('tr.action td:nth-child(3)').text(addValProfile);
              $('#myModalUser').modal('hide');
              removeData();
            } else {
              var args = {
                nombre: getNameVal,
                email: getEmailVal,
                perfil: getProfileVal
              }
              var promise = $.ajax({
                type: 'POST',
                url: getPath + 'mant/adduser',
                headers: {
                  "Content-Type": "application/json",
                  "Authorization": "Bearer "+getTkn
                },
                data: JSON.stringify(args),
                dataType: 'json',
                contentType: 'application/json; charset=utf-8'
              }).done(function(response){
                if(estado.codigoEstado  != '200'){
                  //- console.log(response);
                  openCustomModal('#myModal', 'Genial!', 'Usuario añadido con éxito', 'success');
                }else{
                  openCustomModal('#myModal', 'Genial!', 'No se ha podido añadir el usuario', 'error');
                }
              })
              $('.table tbody').append(craeteTrUser);
              showTooltip();
              $('#myModalUser').modal('hide');
              removeData();
            }
            event.preventDefault();
          }
        }
        
        function removeData() {
          $('#myModalUser #user-name').val('');
          $('#myModalUser #user-mail').val('');
          $('#myModalUser #user-profile').val('');
          $('.table tbody tr').removeClass('action');
          $('.table tbody tr').removeClass('to-delete');
        }
        
        function deleteUser(el) {
          var getTtr        = el.parentElement.parentElement.parentElement.parentElement;
          getTtr.className  = 'to-delete';
        }
        
        function confirmDeleteUser(){
      
          getEmailVal = $('.to-delete td:nth-child(2)').text();
          
          var args = {
            email: getEmailVal
          }
          var promise = $.ajax({
            type: 'POST',
            url: getPath + 'mant/deleteUser',
            headers: {
              "Content-Type": "application/json",
              "Authorization": "Bearer "+getTkn
            },
            data: JSON.stringify(args),
            dataType: 'json',
            contentType: 'application/json; charset=utf-8'
          }).done(function(response){
            if(estado.codigoEstado  != '200'){
              //- console.log(response);
              openCustomModal('#myModal', 'Genial!', 'Usuario eliminado con éxito', 'success');
            }else{
              openCustomModal('#myModal', 'Genial!', 'No se ha podido eliminar el usuario', 'error');
            }
          })
          $('.table tbody tr.to-delete').remove();
        }
        
        function openCustomModal(modal, title, body, theclass){
          $(modal).find('h6').text(title);
          $(modal).find('.modal-body').empty().append(body);
          $(modal).addClass(theclass);
          $(modal).modal({
            backdrop: 'static',
            keyboard: false,
            show: true
          });
        }
        
        addEventListener('click', function (ev) {
          if (ev.target.hash == '#;' || ev.target.hash == '#') {
            ev.preventDefault();
          }
        });
      
      } else {
        window.location.href = getPath;
      }
    </script>
  </body>
</html>