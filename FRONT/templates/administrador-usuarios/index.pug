html(lang="es-CL" dir="ltr" xmlns:og="http://opengraphprotocol.org/schema/" xmlns:fb="http://ogp.me/ns/fb#" heightfull)
  head
    title Administrador Usuarios. MAD Cognitiva
    
    include ../includes/meta.pug
    
  body.no-scroll(heightfull)
  
    #wrapper(heightfull)
      .f-row(heightfull)
        
        include ../includes/menu.pug

        .f-col.content(padding heightfull)
          
          include ../includes/user.pug
          
          .row
            .col-md-12
              .container-tabs#users-list
                .block

                  button(button button-mini margin-bottom onclick="openModal('Añadir nuevo usuario', '#myModalUser')")
                    | Añadir Usuario 
                    i.fa.fa-user-plus(aria-hidden="true")

                  .scroll#AddTable
                    table.table.table-striped.table-bordered
                      thead
                        tr
                          th Nombre
                          th Correo
                          th Perfil
                          th(width="100") Acciones
                      tbody
                        tr#no-users
                          td(colspan="4" text-center) No hay usuarios

    include ../includes/modal.pug
    include ../includes/modal-script.pug
    include ../includes/modal-user.pug
    include ../includes/modal-delete-user.pug

    script(type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js")
    script(type="text/javascript" src= '../assets/js/bootstrap.min.js')
    script(type="text/javascript" src="../assets/js/crypto-js.min.js")
    script(type="text/javascript" src= '../assets/js/main.js')
    script.
      
      if(getPrf < 2) {
        function showTooltip(){
          $('[data-toggle="tooltip"]').tooltip({trigger: "hover"});
        }
        
        function listUsers() {

          var promise = $.ajax({
            type: 'POST',
            url: getPath + 'mant/listusers',
            "headers": {
              "Content-Type": "application/json",
              "Authorization": "Bearer "+getTkn
            },
            //- data: JSON.stringify(args),
            dataType: 'json',
            contentType: 'application/json; charset=utf-8'
          }).done(function(response){
            if(response.status == 200){
              //- console.log(response);
              var craeteTrUser = '';
              for(var i = 0; i < response.descripcion.length; i ++){
                var addProfile = '';
                if (response.descripcion[i].perfil == null){
                  addProfile = 'Añade Perfil';
                } else if(response.descripcion[i].perfil == 0){
                  addProfile = 'Super Admin';
                } else if(response.descripcion[i].perfil == 1){
                  addProfile = 'Editor';
                } else {
                  addProfile = 'Lector';
                }
                var editUser = "editUser(this, '#myModalUser'); openModal('Editar usuario', '#myModalUser')";
                var deleUser = "deleteUser(this); openModal('¿Está seguros de eliminar a este usuario?', '#myModalDeleteUser')";
                var craeteTrUser = '<tr>';
                    craeteTrUser += '  <td>'+response.descripcion[i].nombre+'</td>';
                    craeteTrUser += '  <td>'+response.descripcion[i].email+'</td>';
                    craeteTrUser += '  <td>'+addProfile+'</td>';
                    craeteTrUser += '  <td>';
                    craeteTrUser += '    <ul class="user-actions">';
                    craeteTrUser += '      <li><a href="#;" data-toggle="tooltip" data-placement="top" title="Editar Usuario" onclick="'+editUser+'"><i class="fa fa-pencil" aria-hidden="true"></i></a></li>';
                    craeteTrUser += '      <li><a href="#;" data-toggle="tooltip" data-placement="top" title="Eliminar Usuario" onclick="'+deleUser+'"><i class="fa fa-trash" aria-hidden="true"></i></a></li>';
                    craeteTrUser += '    </ul>';
                    craeteTrUser += '  </td>';
                    craeteTrUser += '</tr>';
                if( getPrf > 0 && response.descripcion[i].perfil > 0 ){
                  $('#AddTable tbody').append(craeteTrUser);
                }
                if(getPrf == 0){
                  $('#AddTable tbody').append(craeteTrUser);
                }
              }
              $('#AddTable #no-users').remove();
              showTooltip();
            } else {
              //- console.log("Error loading page\n");
            }
          });

          //- var req = new XMLHttpRequest();
          //- req.open('POST', getPath+'mant/listusers', true); 
          //- req.send(null);
          //- req.onreadystatechange = function (aEvt) {
          //-   if (req.readyState == 4) {
          //-     if (req.status == 200) {
          //-       var response = JSON.parse(req.responseText);
          //-       console.log(response);
          //-       var craeteTrUser = '';
          //-       for(var i = 0; i < response.descripcion.length; i ++){
          //-         var addProfile = '';
          //-         if (response.descripcion[i].perfil == null){
          //-           addProfile = 'Añade Perfil';
          //-         } else if(response.descripcion[i].perfil == 0){
          //-           addProfile = 'Super Admin';
          //-         } else if(response.descripcion[i].perfil == 1){
          //-           addProfile = 'Editor';
          //-         } else {
          //-           addProfile = 'Lector';
          //-         }

          //-         var editUser = "editUser(this, '#myModalUser'); openModal('Editar usuario', '#myModalUser')";
          //-         var deleUser = "deleteUser(this); openModal('¿Está seguros de eliminar a este usuario?', '#myModalDeleteUser')";
          //-         var craeteTrUser = '<tr>';
          //-             craeteTrUser += '  <td>'+response.descripcion[i].nombre+'</td>';
          //-             craeteTrUser += '  <td>'+response.descripcion[i].email+'</td>';
          //-             craeteTrUser += '  <td>'+addProfile+'</td>';
          //-             craeteTrUser += '  <td>';
          //-             craeteTrUser += '    <ul class="user-actions">';
          //-             craeteTrUser += '      <li><a href="#;" data-toggle="tooltip" data-placement="top" title="Editar Usuario" onclick="'+editUser+'"><i class="fa fa-pencil" aria-hidden="true"></i></a></li>';
          //-             craeteTrUser += '      <li><a href="#;" data-toggle="tooltip" data-placement="top" title="Eliminar Usuario" onclick="'+deleUser+'"><i class="fa fa-trash" aria-hidden="true"></i></a></li>';
          //-             craeteTrUser += '    </ul>';
          //-             craeteTrUser += '  </td>';
          //-             craeteTrUser += '</tr>';

          //-         if( getPrf > 0 && response.descripcion[i].perfil > 0 ){
          //-           $('#AddTable tbody').append(craeteTrUser);
          //-         }
          //-         if(getPrf == 0){
          //-           $('#AddTable tbody').append(craeteTrUser);
          //-         }

          //-       }
          //-       $('#AddTable #no-users').remove();
          //-       showTooltip();
          //-     } else {
          //-       console.log("Error loading page\n");
          //-     }
          //-   }

          //- };

        }
        function validateUserName(name){
          var regex = /^[0-9a-zA-Z\_]+$/;
          return regex.test(name) ? true : false;
        }
        function validateEmail(email) {
          var regex = /^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/;
          return regex.test(email) ? true : false;
        }
        
        function openModal(title, modal) {
          $(modal + ' .modal-title').empty().text(title);
          $(modal).modal('show');
        }
        
        function editUser(el, modal) {
          var getTtr        = el.parentElement.parentElement.parentElement.parentElement,
              getNameTd     = getTtr.children[0].textContent,
              getEmailTd    = getTtr.children[1].textContent,
              getProfileTd  = getTtr.children[2].textContent,
              setValProfile = 0;
          getTtr.className = 'action';
          if(getProfileTd == 'Editor') {
            setValProfile = 1
          } else {
            setValProfile = 2
          }
          $(modal + ' #user-name').val(getNameTd);
          $(modal + ' #user-mail').val(getEmailTd);
          $(modal + ' #user-profile').val(setValProfile);
        }
        
        var mailBool      = false;

        function saveUser() {
          var getNameVal    = document.getElementById('user-name').value,
              getEmailVal   = document.getElementById('user-mail').value,
              getProfileVal = document.getElementById('user-profile').value, 
              addValProfile = '',
              getSelect     = false;
          if(getProfileVal.length > 0){
            getSelect = true;
          } else {
            getSelect = false;
          }
          if(getNameVal.trim() != '' && !validateUserName(getNameVal)){
            var usernameField = document.getElementById('user-name');
            alert("No se permiten caracteres especiales");
            return;
          }
          if(!validateEmail(getEmailVal)){
            var emailfield  = document.getElementById('user-mail');
            emailfield.setCustomValidity("Complete el campo correspondiente");
          }
          if(getEmailVal.trim() != '' && getEmailVal.length <= 45 && getNameVal.trim() != ''  && getNameVal.length <= 45 && getSelect == true && validateEmail(getEmailVal) == true){
            if(getProfileVal == 1){
              addValProfile = 'Editor';
            } else {
              addValProfile = 'Lector';
            }
            var editUser = "editUser(this, '#myModalUser'); openModal('Editar usuario', '#myModalUser')";
            var deleUser = "deleteUser(this); openModal('¿Está seguros de eliminar a este usuario?', '#myModalDeleteUser')";
            var craeteTrUser = '<tr>';
                craeteTrUser += '  <td>'+getNameVal+'</td>';
                craeteTrUser += '  <td>'+getEmailVal+'</td>';
                craeteTrUser += '  <td>'+addValProfile+'</td>';
                craeteTrUser += '  <td>';
                craeteTrUser += '    <ul class="user-actions">';
                craeteTrUser += '      <li><a href="#;" data-toggle="tooltip" data-placement="top" title="Editar Usuario" onclick="'+editUser+'"><i class="fa fa-pencil" aria-hidden="true"></i></a></li>';
                craeteTrUser += '      <li><a href="#;" data-toggle="tooltip" data-placement="top" title="Eliminar Usuario" onclick="'+deleUser+'"><i class="fa fa-trash" aria-hidden="true"></i></a></li>';
                craeteTrUser += '    </ul>';
                craeteTrUser += '  </td>';
                craeteTrUser += '</tr>';
            if($('.table tbody tr').hasClass('action')){
              if(!validateUserName(getNameVal)){
              var usernameField = document.getElementById('user-name');
              //- usernameField.addClass('invalid-input');
              var span = $('<span />').attr({'class':'error-span' }).html('No se permiten caracteres especiales');
              $('#user-name').html(span);
              }
              var args = {
                nombre: getNameVal,
                email: getEmailVal,
                perfil: getProfileVal
              }
              var promise = $.ajax({
                type: 'POST',
                url: getPath + 'mant/edituser',
                headers: {
                  "Content-Type": "application/json",
                  "Authorization": "Bearer "+getTkn
                },
                data: JSON.stringify(args),
                dataType: 'json',
                contentType: 'application/json; charset=utf-8'
              }).done(function(response){
                if(response.status  == '200' && response.estado == undefined){
                  //- console.log(response);
                  openCustomModal('#myModal', 'Genial!', 'El usuario se ha editado con éxito', 'success');
                  var table = document.getElementById('users-list').getElementsByTagName('TABLE')[0],
                    rows = table.getElementsByTagName('TBODY')[0].getElementsByTagName('TR'),
                    lastRow = rows[rows.length - 1],
                    columnas = lastRow.getElementsByTagName('TD');
                  columnas[0].innerText = getNameVal;
                  columnas[1].innerText = getEmailVal;
                  columnas[2].innerText = addValProfile;
                }else{
                  openCustomModal('#myModal', 'Ups!', 'No se ha podido editar el usuario', 'error');
                }
              })
              $('#myModalUser').modal('hide');
              removeData();
            } else {
              var args = {
                nombre: getNameVal,
                email: getEmailVal,
                perfil: getProfileVal
              }
              var promise = $.ajax({
                type: 'POST',
                url: getPath + 'mant/adduser',
                headers: {
                  "Content-Type": "application/json",
                  "Authorization": "Bearer "+getTkn
                },
                data: JSON.stringify(args),
                dataType: 'json',
                contentType: 'application/json; charset=utf-8'
              }).done(function(response){
                if(response.status  == '200' && response.estado == undefined){
                  //- console.log(response);
                  openCustomModal('#myModal', 'Genial!', 'Usuario añadido con éxito', 'success');
                  $('.table tbody').append(craeteTrUser);
                }else{
                  openCustomModal('#myModal', 'Ups!', 'No se ha podido añadir el usuario', 'error');
                }
              })
              showTooltip();
              $('#myModalUser').modal('hide');
              removeData();
            }
            event.preventDefault();
          }
        }
        
        function removeData() {
          $('#myModalUser #user-name').val('');
          $('#myModalUser #user-mail').val('');
          $('#myModalUser #user-profile').val('');
          $('.table tbody tr').removeClass('action');
          $('.table tbody tr').removeClass('to-delete');
        }
        
        function deleteUser(el) {
          var getTtr        = el.parentElement.parentElement.parentElement.parentElement;
          getTtr.className  = 'to-delete';
        }
        
        function confirmDeleteUser(){

          getEmailVal = $('.to-delete td:nth-child(2)').text();
          
          var args = {
            email: getEmailVal
          }
          var promise = $.ajax({
            type: 'POST',
            url: getPath + 'mant/deleteUser',
            headers: {
              "Content-Type": "application/json",
              "Authorization": "Bearer "+getTkn
            },
            data: JSON.stringify(args),
            dataType: 'json',
            contentType: 'application/json; charset=utf-8'
          }).done(function(response){
            if(response.status  == '200' && response.estado == undefined){
              //- console.log(response);
              openCustomModal('#myModal', 'Genial!', 'Usuario eliminado con éxito', 'success');
              $('.table tbody tr.to-delete').remove();
            }else{
              openCustomModal('#myModal', 'Ups!', 'No se ha podido eliminar el usuario', 'error');
            }
          })
        }
        
        function openCustomModal(modal, title, body, theclass){
          $(modal).find('h6').text(title);
          $(modal).find('.modal-body').empty().append(body);
          $(modal).removeClass('error');
          $(modal).removeClass('succes')
          $(modal).addClass(theclass);
          $(modal).modal({
            backdrop: 'static',
            keyboard: false,
            show: true
          });
        }
        
        addEventListener('click', function (ev) {
          if (ev.target.hash == '#;' || ev.target.hash == '#') {
            ev.preventDefault();
          }
        });

        function initial(){
          if(hasToken){
            showTooltip();
            listUsers();
          }else{
            setTimeout(()=>{
              initial();
            },300);
          }
        }

        initial();

      } else {
        window.location.href = getPath;
      }